name: Docker Build
description: Build Docker image with buildx and cache

inputs:
  image-name:
    description: Image name (used for cache key)
    required: true
  dockerfile:
    description: Path to Dockerfile
    default: 'Dockerfile'
  context:
    description: Docker build context
    default: '.'
  build-args:
    description: Docker build arguments (KEY=VALUE, one per line)
    default: ''
  platforms:
    description: Target platforms (e.g., linux/amd64,linux/arm64)
    default: 'linux/amd64'

outputs:
  digest:
    description: Image digest
    value: ${{ steps.build.outputs.digest }}
  metadata:
    description: Build metadata JSON
    value: ${{ steps.build.outputs.metadata }}

runs:
  using: composite
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build image
      id: build
      uses: docker/build-push-action@v6
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: ${{ inputs.platforms }}
        push: false
        load: true
        tags: ${{ inputs.image-name }}:local
        build-args: ${{ inputs.build-args }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
