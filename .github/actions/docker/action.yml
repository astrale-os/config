name: Docker Build and Push
description: Build once, push to multiple registries (ghcr.io and/or GAR)

inputs:
  image-name:
    description: Docker image name (without registry prefix)
    required: true
  version:
    description: Image version tag
    required: true
  dockerfile:
    description: Path to Dockerfile
    default: 'Dockerfile'
  context:
    description: Docker build context
    default: '.'
  build-args:
    description: Docker build arguments (KEY=VALUE, one per line)
    default: ''
  push:
    description: Push the image to registry
    default: 'true'
  ghcr-token:
    description: GitHub token with packages:write (enables ghcr.io push)
    required: false
    default: ''
  gar-project:
    description: GCP project ID for Artifact Registry (enables GAR push)
    required: false
    default: ''
  gar-region:
    description: GAR region (default europe-west1)
    required: false
    default: 'europe-west1'
  gar-workload-identity-provider:
    description: Workload Identity Provider for GAR auth
    required: false
    default: ''
  gar-service-account:
    description: Service account for GAR auth
    required: false
    default: ''

outputs:
  ghcr-image:
    description: Full ghcr.io image path with tag
    value: ${{ steps.meta.outputs.ghcr-image }}
  gar-image:
    description: Full GAR image path with tag
    value: ${{ steps.meta.outputs.gar-image }}
  digest:
    description: Image digest
    value: ${{ steps.build.outputs.digest }}

runs:
  using: composite
  steps:
    - name: Login to GitHub Container Registry
      if: inputs.ghcr-token != ''
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.ghcr-token }}

    - name: Authenticate to Google Cloud
      if: inputs.gar-project != ''
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ inputs.gar-workload-identity-provider }}
        service_account: ${{ inputs.gar-service-account }}

    - name: Login to Artifact Registry
      if: inputs.gar-project != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.gar-region }}-docker.pkg.dev

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Generate image metadata
      id: meta
      shell: bash
      run: |
        VERSION="${{ inputs.version }}"
        SHA="${{ github.sha }}"
        SHORT_SHA="${SHA:0:7}"
        TAGS=""
        
        # ghcr.io tags
        if [ -n "${{ inputs.ghcr-token }}" ]; then
          OWNER="${{ github.repository_owner }}"
          OWNER_LOWER=$(echo "$OWNER" | tr '[:upper:]' '[:lower:]')
          GHCR="ghcr.io/${OWNER_LOWER}/${{ inputs.image-name }}"
          echo "ghcr-image=${GHCR}:${VERSION}" >> $GITHUB_OUTPUT
          TAGS="${GHCR}:${VERSION},${GHCR}:${SHORT_SHA},${GHCR}:latest"
        fi
        
        # GAR tags
        if [ -n "${{ inputs.gar-project }}" ]; then
          GAR="${{ inputs.gar-region }}-docker.pkg.dev/${{ inputs.gar-project }}/${{ inputs.image-name }}/${{ inputs.image-name }}"
          echo "gar-image=${GAR}:${VERSION}" >> $GITHUB_OUTPUT
          if [ -n "$TAGS" ]; then
            TAGS="${TAGS},${GAR}:${VERSION},${GAR}:${SHORT_SHA},${GAR}:latest"
          else
            TAGS="${GAR}:${VERSION},${GAR}:${SHORT_SHA},${GAR}:latest"
          fi
        fi
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT

    - name: Build and push
      id: build
      uses: docker/build-push-action@v6
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        push: ${{ inputs.push }}
        tags: ${{ steps.meta.outputs.tags }}
        build-args: ${{ inputs.build-args }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
